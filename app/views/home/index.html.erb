<div id="left">
  <h3>Kamiflex<h3>
  <div id="editor">
  </div>
  <h3>Json<h3>
  <div id="json_viewer">
  </div>
</div>

<div id="right">
  <h3>Flex Message<h3>
  <div id="line_flex_message">
  </div>
</div>

<script>
var editor = monaco.editor.create(document.getElementById("editor"), {
	value: `Kamiflex.hash(self) do
  alt_text "hello world!"
  bubble do
    body do
      text "hello world!"
    end
  end
end`,
	language: "ruby"
});

let jsonViewer = monaco.editor.create(document.getElementById("json_viewer"), {
  value: `{
    "a":"b"
}`,
  readOnly: true,
  language: "ruby"
})

function updateJsonViewer(flexMessage){
  window.json = JSON.stringify(flexMessage, null, 2)
  jsonViewer.setValue(window.json);
}

async function getFlexMessage(){
  return await $.post({
    url: "/kamiflex",
    data: JSON.stringify({
      code: editor.getValue()
    }),
    contentType: "application/json",
    dataType: 'json'
  });
}

function updateFlexMessageViewer(flexMessage){
  $("#line_flex_message").html("")
  flex2html("line_flex_message", flexMessage)
}

async function update(){
  const flexMessage = await getFlexMessage()
  updateFlexMessageViewer(flexMessage)
  updateJsonViewer(flexMessage)
}

document.addEventListener("keyup", function(e){
  update();
});
update();
</script>